#!/usr/bin/env ruby
require "socket"

host = ENV.fetch("PGHOST", "localhost")
port = Integer(ENV.fetch("PGPORT", "5432"))

begin
  Socket.tcp(host, port, connect_timeout: 1) { |socket| socket.close }
rescue StandardError => error
  warn "PostgreSQL is not reachable at #{host}:#{port} (#{error.class})."
  warn "Start PostgreSQL and retry."
  warn "If you use Docker: export PGHOST=127.0.0.1 PGUSER=postgres PGPASSWORD=postgres"
  exit 1
end

exec "./bin/rails", "server", *ARGV
